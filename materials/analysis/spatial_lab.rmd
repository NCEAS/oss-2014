Spatial analysis lab
=========================

[see also](http://labs.bio.unc.edu/Buckley/documents/AnselinIntroSpatRegres.pdf)

## Constructing weight matrices

```{r message=FALSE}
library(spdep)
```
```{r}                                               
nyfile <- system.file("etc/misc/nydata.dbf", package="spdep")
nydata0 <- read.dbf(nyfile)  ## read.dbf is from the foreign package, auto-loaded by spdep
head(nydata0)
```

```{r}
nydata <- nydata0  ## make a copy to turn into a 'sp' object
coordinates(nydata) <- c("X", "Y")  ## set coordinates
nycoord <- coordinates(nydata)      ## retrieve coordinates
## or: nycoord <- nydata[,c("X","Y")] *before* setting coordinates(nydata)
```

* Use `View()`/`plot()`/`summary()`/etc. to investigate `nydata`. (Use `?nydata`. Or try
```{r fig.keep="none"}
library(ggplot2)
theme_set(theme_bw())
ggplot(nydata0,aes(x=X,y=Y,size=PROPCAS,color=PEXPOSURE))+
       geom_point(alpha=0.5)
```

The "neighbour-list" (`nb`) and "weight list" (`listw`) structures are
the basic components of SAR/CAR/Moran's I/etc.

Explore the available functions for converting to and from these
object types, and doing things with them:
```{r}
## use regular expressions! ^='beginning of line', $='end of line'
apropos("(^nb2|2nb$)")
apropos("(^listw2|2listw$)")
methods(class="nb")
methods(class="listw")
```

Construct Delaunay tesselation (triangulation)/Voronoi diagram:
graph of nearest neighbors.
```{r message=FALSE}
library(deldir)
nynb <- tri2nb(nycoord)
plot(nynb,nycoord)  ## SLOW
```

```{r}
## compute 1st- and 2d-order neighbours:
(col.lags <- nblag(nynb, 2))
```

```{r}
plot(nynb,nycoord)
plot(col.lags[[2]], nycoord, add=TRUE,
     col=adjustcolor("red",alpha=0.5))
cuml <- nblag_cumul(col.lags) ## collapse first- & second-order neighbors
plot(cuml,nycoord)
```

Distance-based weight matrix:
```{r}
nymat2 <- as.matrix(dist(nycoord))<20
nymat2[] <- as.numeric(nymat2) ## convert without losing matrix structure
## note 'dist' takes alternative metrics such as 'manhattan'
listw_NY <- mat2listw(nymat2)
plot(listw_NY,nycoord,col=adjustcolor("black",alpha=0.5))
```

Use pre-computed adjacency matrix:
```{r message=FALSE}
nyadjfile <- system.file("etc/misc/nyadjwts.dbf",package="spdep")
nyadjdat <- read.dbf(nyadjfile)
```
Lots of messages, generated by trying to make fields unique
```{r}
nyadjmat <- as.matrix(nyadjdat[,-1]) ## first column is an ID variable
ID <- names(nyadjdat)[-1]
## check that area keys and IDs are the same ...
identical(substring(ID, 2, 10), substring(as.character(nydata$AREAKEY), 2, 10))
nyadjlw <- mat2listw(nyadjmat, ID)
listw_NY <- nb2listw(nyadjlw$neighbours, style="B")
 ```

```{r plot1}
## plot prop. cases vs exposure, weight smooth and adjust point size
## by pop size
ggplot(nydata0,
       aes(x=PEXPOSURE,y=PROPCAS))+
     geom_point(aes(size=POP8),alpha=0.5)+
     geom_smooth(aes(weight=POP8,method="loess"))
```

```{r lm1}
lm1 <- lm(PROPCAS~PEXPOSURE,weights=POP8,data=nydata0)
summary(lm1)
lm.morantest(lm1,listw_NY)  ## reject null (just ...)
```
See also `lm.LMtests` and `moran.test`

```{r}
lm1F <- data.frame(fortify(lm1),subset(nydata0,select=c(X,Y)))
ggplot(lm1F,aes(x=X,y=Y))+
    geom_point(aes(size=abs(.resid),
                   colour=.resid),alpha=0.5)+
    scale_colour_gradient(low="red",high="blue")
```

We'd probably better check out that giant residual and do
something about it ...

## Geostatistical

```{r}
library(nlme)
g1 <- gls(PROPCAS~PEXPOSURE,weights=varFixed(~1/POP8),
          data=nydata0)
plot(Variogram(g1),ylim=c(0,1.5))
```
There doesn't actually seem to be much going on here ...

```{r}
g1M <- update(g1,method="ML")
g2 <- update(g1,.~.+poly(X,Y,degree=2))
g2M <- update(g2,method="ML")
anova(g1M,g2M,test=TRUE)
plot(Variogram(g2,form=~X+Y),ylim=c(0,1.5))
```
... and there's even less when we subtract the spatial trend.

Nevertheless we will forge ahead and try to fit a spatial model.

If you have time, try out the `likfit` function from the `geoR` package ...


